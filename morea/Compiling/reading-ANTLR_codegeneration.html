<!DOCTYPE html>
<html>
<head>
  <title> A simple ANTLR compiler | ICS 312 Spring 2021 </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">

  <!--  Load bootswatch-based Morea theme file. -->
  <link rel="stylesheet" href="/ics312_spring2021/css/themes/cerulean/bootstrap.min.css">
  <link rel="stylesheet" href="/ics312_spring2021/css/style.css">
  <link rel="stylesheet" href="/ics312_spring2021/css/syntax.css">
  <link rel="shortcut icon" href="/ics312_spring2021/favicon.ico" type="image/x-icon"/>

  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/respond.js/1.2.0/respond.js"></script>
  <![endif]-->

  <!-- Load Bootstrap JavaScript components -->
  <script src="//code.jquery.com/jquery.min.js"></script>
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

  
  <script type="text/javascript"
          src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  

  

  <script>
    $(window).load(function () {
      // If on a page associated with a navbar item, make its navbar item 'active'.
      $('.navbar-nav').find('a[href="' + location.pathname + '"]').parents('li').addClass('active');
    });
  </script>

</head>
<body>
<!-- Responsive navbar -->
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <!--  Display three horizontal lines when navbar collapsed. -->
        <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/ics312_spring2021/index.html"> ICS 312 Spring 2021 </a>
    </div>
    <div class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        
        <li><a href="/ics312_spring2021/modules/">Modules</a></li>
        
        <li><a href="/ics312_spring2021/outcomes/">Outcomes</a></li>
        
        
        <li><a href="/ics312_spring2021/readings/">Readings</a></li>
        
        
        <li><a href="/ics312_spring2021/experiences/">Experiences</a></li>
        
        
        <li><a href="/ics312_spring2021/assessments/">Assessments</a></li>
        
        
      </ul>
    </div>
  </div>
</div>


<div class="breadcrumb-bar">
  <div class="container">
    <ol class="breadcrumb">
      
      <li><a href="/ics312_spring2021/">Home</a></li>
      <li><a href="/ics312_spring2021/modules">Modules</a></li>
      <li><a href="/ics312_spring2021/modules/"></a></li>
      <li class="active">A simple ANTLR compiler</li>
    </ol>
  </div>
</div>


<div class="container">
  <h2 id="a-simple-antlr-compiler">A Simple ANTLR Compiler</h2>

<p>Here is the compiler we developed in class 
have developed it in class or close
(you can download the file <a href="./MyLanguageV0Code.g4">here</a>):</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">// A simple syntax-directed translator for a simple language

grammar MyLanguageV0Code;

// Root non-terminal symbol
// A program is a bunch of declarations followed by a bunch of statements
// The Java code outputs the necessary NASM code around these declarations

program       : 
              {System.out.println("%include \"asm_io.inc\"");
               System.out.println("segment .bss"); }
              declaration*
              {System.out.println("segment .text"); 
               System.out.println("\tglobal asm_main"); 
               System.out.println("asm_main:"); 
               System.out.println("\tenter 0,0"); 
               System.out.println("\tpusha"); }
              statement*
              {System.out.println("\tpopa"); 
               System.out.println("\tmov eax,0"); 
               System.out.println("\tleave"); 
               System.out.println("\tret"); } 
              ;

// Parse rule for variable declarations

declaration   : 
              {int a; }
              INT a=NAME SEMICOLON
              {System.out.println("\t"+$a.text + "  resd 1");}
              ;

// Parse rule for statements

statement      : 
               ifstmt 
             | printstmt 
             | assignstmt 
               ;

// Parse rule for if statements

ifstmt      : 
            {int a,b;} 
            {String label;}
            IF LPAREN a=identifier EQUAL b=integer RPAREN
            {System.out.println("\tcmp dword "+$a.toString+","+$b.toString);
             label = "label_"+Integer.toString($IF.index);
             System.out.println("\tjnz "+label); }
            statement*
            { System.out.println(label+":"); }
            ENDIF
            ;


// Parse rule for print statements

printstmt      : 
               PRINT term SEMICOLON 
               {System.out.println("\tmov eax, "+$term.toString);
                System.out.println("\tcall print_int");
                System.out.println("\tcall print_nl");} 
               ;

// Parse rule for assignment statements

assignstmt      : 
                {int a; }
                a=NAME ASSIGN expression SEMICOLON 
                {System.out.println("\tmov ["+$a.text+"], eax");} 
                ;

// Parse rule for expressions

expression      : 
                {int a,b; }
                a=term 
                {System.out.println("\tmov eax,"+$a.toString);}
              | 
                a=term PLUS b=term 
                {System.out.println("\tmov eax,"+$a.toString);}
                {System.out.println("\tadd eax,"+$b.toString);}
                ;

// Parse rule for terms

term returns [String toString]  : 
                                identifier {$toString = $identifier.toString;} 
                              | integer {$toString = $integer.toString;} 
                                ;

// Parse rule for identifiers

identifier returns [String toString]: NAME {$toString = "["+$NAME.text+"]";} ;

// Parse rule for numbers 

integer returns [String toString]: INTEGER {$toString = $INTEGER.text;} ;


// Reserved Keywords
////////////////////////////////

IF: 'if';
ENDIF: 'endif';
PRINT: 'print';
INT: 'int';

// Operators
PLUS: '+';
EQUAL: '==';
ASSIGN: '=';
NOTEQUAL: '!=';

// Semicolon and parentheses
SEMICOLON: ';';
LPAREN: '(';
RPAREN: ')';

// Integers
INTEGER: [0-9][0-9]*;

// Variable names
NAME: [a-z]+;   

// Ignore all white spaces 
WS: [ \t\r\n]+ -&gt; skip ; </code></pre></figure>

<p>Let us try to run ANTLR on a source file named sourcecode.txt with content:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">int a;
int b;
a = 3;
b = a + 1;
if (b == 4) a = 2; endif
if (a == 3)  
    a = a + 1; 
    b = b + 6;
endif 
print a;
print b;</code></pre></figure>

<p>Let us now run ANTLR and out parser:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">% java -jar ./antlr-4.8-complete.jar MyLanguageV0Code.g4

% javac -cp .:./antlr-4.8-complete.jar MyLanguageV0Code*.java

% java -cp .:./antlr-4.8-complete.jar org.antlr.v4.gui.TestRig MyLanguageV0Code program sourcecode.txt</code></pre></figure>

<p>The output is:</p>

<figure class="highlight"><pre><code class="language-nasm" data-lang="nasm"><span class="cp">%include "asm_io.inc"
</span><span class="nf">segment</span> <span class="nv">.data</span>
	<span class="nf">a</span>  <span class="nv">dd</span> <span class="mi">0</span>
	<span class="nf">b</span>  <span class="nv">dd</span> <span class="mi">0</span>
<span class="nf">segment</span> <span class="nv">.text</span>
	<span class="nf">global</span> <span class="nv">asm_main</span>
<span class="nl">asm_main:</span>
	<span class="nf">enter</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
	<span class="nf">pusha</span>
	<span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span><span class="mi">3</span>
	<span class="nf">mov</span> <span class="p">[</span><span class="nv">a</span><span class="p">],</span> <span class="nb">eax</span>
	<span class="nf">mov</span> <span class="nb">eax</span><span class="p">,[</span><span class="nv">a</span><span class="p">]</span>
	<span class="nf">add</span> <span class="nb">eax</span><span class="p">,</span><span class="mi">1</span>
	<span class="nf">mov</span> <span class="p">[</span><span class="nv">b</span><span class="p">],</span> <span class="nb">eax</span>
<span class="nf">cmp</span> <span class="kt">dword</span> <span class="p">[</span><span class="nv">b</span><span class="p">],</span><span class="mi">4</span>
<span class="nf">jnz</span> <span class="nv">label_16</span>
	<span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span><span class="mi">2</span>
	<span class="nf">mov</span> <span class="p">[</span><span class="nv">a</span><span class="p">],</span> <span class="nb">eax</span>
<span class="nl">label_16:</span>
<span class="nf">cmp</span> <span class="kt">dword</span> <span class="p">[</span><span class="nv">a</span><span class="p">],</span><span class="mi">3</span>
<span class="nf">jnz</span> <span class="nv">label_27</span>
	<span class="nf">mov</span> <span class="nb">eax</span><span class="p">,[</span><span class="nv">a</span><span class="p">]</span>
	<span class="nf">add</span> <span class="nb">eax</span><span class="p">,</span><span class="mi">1</span>
	<span class="nf">mov</span> <span class="p">[</span><span class="nv">a</span><span class="p">],</span> <span class="nb">eax</span>
	<span class="nf">mov</span> <span class="nb">eax</span><span class="p">,[</span><span class="nv">b</span><span class="p">]</span>
	<span class="nf">add</span> <span class="nb">eax</span><span class="p">,</span><span class="mi">6</span>
	<span class="nf">mov</span> <span class="p">[</span><span class="nv">b</span><span class="p">],</span> <span class="nb">eax</span>
<span class="nl">label_27:</span>
	<span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nv">a</span><span class="p">]</span>
	<span class="nf">call</span> <span class="nv">print_int</span>
	<span class="nf">call</span> <span class="nv">print_nl</span>
	<span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="p">[</span><span class="nv">b</span><span class="p">]</span>
	<span class="nf">call</span> <span class="nv">print_int</span>
	<span class="nf">call</span> <span class="nv">print_nl</span>
	<span class="nf">popa</span>
	<span class="nf">mov</span> <span class="nb">eax</span><span class="p">,</span><span class="mi">0</span>
	<span class="nf">leave</span>
	<span class="nf">ret</span></code></pre></figure>

<p>You can now run this code using NASM, and check that it works! Our
compiler has MANY weaknesses and is a far cry from a production
compiler. For instance:</p>

<ul>
  <li>
    <p>It doesn’t catch undeclared variables</p>
  </li>
  <li>
    <p>It makes very poor use of the register set</p>
  </li>
  <li>
    <p>It leads to assembly code with wasteful instructions</p>
  </li>
</ul>

<p>Addressing the above is very interesting, but would unfortunately
take us well beyond the scope of this course. Instead, 
in the programming assignment in this module we will add to the language, and you
will thus have to extend the compiler.</p>

<h4 id="useful-makefile">Useful Makefile</h4>

<p>You can get this useful Makefile: <a href="./Makefile_ANTLR_x86">Makefile_ANTLR_x86</a> (which you should rename as just “Makefile” if you want to just be able to type “make”</p>

<hr />


</div>




<script src="/ics312_spring2021/js/scrollIfAnchor.js"></script>

<div class="footer-background hidden-print">
  <footer>
    <div class="container page-footer">
      
      No footer page content supplied.
      
      <p style="margin: 0">Powered by the <a href="http://morea-framework.github.io/">Morea Framework</a> (Theme: cerulean)<br>
        Last update on: <span>2021-01-25 12:02:59 -1000</span></p>

      <p style="margin: 0">
        
        4 modules
        
        | 11 outcomes
        
        
        | 56 readings
        
        
        | 10 experiences
        
        
        | 17 assessments
        
      </p>
    </div>
  </footer>
</div>
</body>
</html>
